////
Corrective/Preventive Action (CAPA) Process

Document Metadata:
- Document ID: 03-CAPA_PROCESS
- Version: 1.0.0
- Created: 2025-10-30T00:00:00Z
- Purpose: Define CAPA workflow for defect fixes and preventive actions
- Scope: CAPA creation, QA validation, FMEA decision, release approval
- Document Type: Process Definition
- Part of: GOVERNANCE_REFERENCE_MANUAL.adoc (Chapter 3)
////

= Chapter 3: Corrective/Preventive Action (CAPA) Process

**Document ID:** 03-CAPA_PROCESS
**Version:** 1.0.0
**Status:** Active
**Last Updated:** October 30, 2025
**Owner:** Robert A. James (QA/PM)

---

== Chapter Overview

A **CAPA (Corrective/Preventive Action)** is a formal issue tracking record for defects, bugs, and preventive improvements. Unlike **ECR** (which proposes new features), CAPA addresses existing problems:

- **Corrective:** Fixes a defect found in testing or production
- **Preventive:** Addresses potential risk before it becomes a defect

Every CAPA linked to:
- GitHub issue (GitHub Issues = CAPA tracking system)
- Git commits (references in commit messages)
- Version tag (when released)
- QA validation (regression test + FMEA decision)
- PM approval (final release authority)

---

== CAPA Lifecycle

```
┌──────────────────────────────────┐
│ STEP 1: CREATE CAPA ISSUE        │
│ (GitHub Issue #NNN)              │
│ • Title: [TYPE] Brief description│
│ • Description: Problem statement │
│ • Status: SUBMITTED              │
└────────────┬─────────────────────┘
             │
┌────────────▼─────────────────────┐
│ STEP 2: DEVELOPER FIXES          │
│ • Create feature/fix branch      │
│ • Implement fix                  │
│ • Add regression test            │
│ • Create PR (Closes #NNN)        │
│ • GitHub Actions validates       │
│ • Status: IN_PROGRESS            │
└────────────┬─────────────────────┘
             │
    ┌────────┴────────┐
    │                 │
  PASS             FAIL
    │                 │
    │          [Return to dev]
    │          Retry Step 2
    │
┌───┴─────────────────────────────┐
│ STEP 3: QA VALIDATION           │
│ • Review fix matches CAPA       │
│ • Verify regression test added  │
│ • Assess FMEA requirement       │
│ • Approve or reject             │
│ • Status: VALIDATING            │
└────────────┬────────────────────┘
             │
    ┌────────┴─────────┐
    │                  │
  APPROVE         REJECT
    │                  │
    │          [Return to dev]
    │          QA comments with
    │          specific issues
    │
┌───┴──────────────────────────────┐
│ STEP 4: FMEA DECISION GATE       │
│ QA determines if formal FMEA     │
│ analysis required:               │
│ • No FMEA: Simple fix            │
│ • Optional FMEA: Medium risk     │
│ • Required FMEA: Complex defect  │
│ • Status: FMEA_DECISION_MADE     │
└────────────┬────────────────────┘
             │
┌────────────▼──────────────────────┐
│ STEP 5: PM RELEASE DECISION       │
│ PM approves release (1-day SLA)   │
│ • All tests pass? ✓              │
│ • Coverage maintained? ✓          │
│ • QA approved? ✓                 │
│ • FMEA complete (if required)? ✓ │
│ • Status: READY_FOR_RELEASE      │
└────────────┬──────────────────────┘
             │
┌────────────▼──────────────────────┐
│ STEP 6: RELEASED                 │
│ • Merged to master               │
│ • Version tagged (vX.Y.Z)        │
│ • Released to users              │
│ • Issue auto-closes              │
│ • Status: CLOSED / RELEASED      │
└───────────────────────────────────┘
```

---

== CAPA Issue Creation

=== Who Creates CAPA?

- **Developer:** Finds bug during own testing
- **QA:** Finds bug during testing
- **User:** Reports bug (converted to CAPA by PM)
- **Nightly CI:** Jenkins torture test finds regression

=== CAPA GitHub Issue Template

```markdown
## [TYPE] Brief Description of Defect

### 1. What is the Problem?
Clear, concise description of the defect:
- What happens? (observed behavior)
- What should happen? (expected behavior)
- Impact: (critical/major/minor)

### 2. How to Reproduce
Step-by-step instructions:
1. ...
2. ...
3. Observe: [defect occurs]

### 3. Expected Behavior
What should happen instead?

### 4. Environment
- StarForth version: (v2.0.1, main branch, etc.)
- Platform: (x86_64, ARM64)
- OS: (Kubuntu, etc.)
- Related code: (file/function names)

### 5. Type of Change
- [ ] Bug fix (defect in existing code)
- [ ] Performance regression (slowdown)
- [ ] Memory leak (Valgrind finding)
- [ ] Security vulnerability (CVE candidate)
- [ ] Test failure (regression)
- [ ] Documentation correction

### 6. Proposed Root Cause (Optional)
If known:
- Suspected cause: ...
- Likely location in code: ...

### 7. Severity Assessment
- [ ] CRITICAL: Data loss, security breach, crash
- [ ] MAJOR: Feature broken, significant impact
- [ ] MINOR: Small issue, workaround available
- [ ] DOCUMENTATION: Docs incorrect/missing
```

=== CAPA Naming Convention

**GitHub Issue:** #NNN (auto-assigned by GitHub)

**CAPA Reference in commits:** `CAPA #NNN: Brief description`

Example:
```
commit abc123
Author: Robert A. James <rajames@example.com>
Date: Wed Oct 30 15:30:00 2025

fix: CAPA #42 - Fix stack underflow in DROP word

The DROP word was not checking if the data stack
had at least one element before popping. This caused
a segfault if DROP was called on empty stack.

Added bounds check: return error if stack_ptr < 1
Regression test: tests/test_capa_42.c validates fix

Closes #42
```

---

== QA Validation Checklist (Step 3)

When QA receives a PR linked to CAPA:

```
QA VALIDATION CHECKLIST (CAPA #NNN)
═══════════════════════════════════════════════════════════════

CAPA: CAPA #42 - {Brief Description}
QA Reviewer: Robert A. James
Date: {Date}

REQUIREMENTS VERIFICATION
☐ Does PR implementation fix the reported problem?
  Verification: Reproduce original defect, confirm fix resolves it
☐ Did QA test the fix locally?
  Verification: Run test scenario from CAPA description
☐ Does fix prevent original problem (no workaround)?
  Verification: Confirm defect is gone, not just masked

TEST COVERAGE
☐ New regression test added?
  Verification: Check tests/ directory for test_capa_NNN.c
☐ Test validates fix (would catch regression)?
  Verification: Review test case logic
☐ All tests pass (≥99% pass rate)?
  Verification: GitHub Actions shows all tests passing
☐ Code coverage maintained (≥85%)?
  Verification: Coverage report shows no degradation

REGRESSION TESTING
☐ No performance degradation (≤10%)?
  Verification: Benchmark comparison
☐ No new crashes or memory errors (Valgrind)?
  Verification: Valgrind output clean
☐ Existing functionality still works?
  Verification: Full test suite passes

CODE QUALITY
☐ No compiler warnings (-Wall -Werror)?
  Verification: Build log shows zero warnings
☐ Code follows ANSI C99 standard?
  Verification: Code review checklist
☐ Non-obvious logic documented?
  Verification: Comments explain fix rationale

DOCUMENTATION
☐ CLAUDE.md updated (if build change)?
☐ README.md updated (if user-facing)?
☐ CAPA issue has clear description?
☐ Test case documented?

SECURITY REVIEW (if applicable)
☐ Fix doesn't introduce new vulnerabilities?
☐ Input validation added (if memory issue)?
☐ Bounds checking proper (if buffer-related)?
☐ No hardcoded secrets introduced?

DECISION
═══════════════════════════════════════════════════════════════

☐ ✅ APPROVED - Ready for PM release decision
   QA: {Name}, Date: {Date}

☐ ✅ APPROVED WITH CONDITIONS - Document conditions
   Conditions: {List specific requirements}

☐ ❌ REJECTED - Return to developer
   Issues: {Specific problems to fix}
   Next: Developer revises and re-submits

═══════════════════════════════════════════════════════════════
```

---

== FMEA Decision Gate (Step 4)

After QA approves, determine if formal FMEA required:

=== FMEA Requirement Matrix

[cols="1,2,3,2"]
|===
|Defect Type |Complexity |Decision |Process

|**Simple Bug** |Single-function fix, obvious root cause |No FMEA |Proceed to release
|**Logic Error** |Multi-function impact, subtle root cause |Optional FMEA |QA brief risk assessment
|**System Issue** |Complex root cause, affects verified code, potential systemic problem |REQUIRED FMEA |QA conducts formal FMEA
|===

=== FMEA Risk Scoring

**Factors that trigger REQUIRED FMEA:**

[cols="1,3,2"]
|===
|Factor |Description |Triggers FMEA?

|Verified Code |Touches formally-verified FORTH-79 words |YES
|Systemic Risk |Same class of bug likely elsewhere |YES
|New Algorithm |Introduces new logic (not just bug fix) |YES
|Security Issue |CVE-level vulnerability |YES
|Memory Corruption |Buffer overflow, use-after-free, double-free |YES
|Crash/Deadlock |Race condition, infinite loop, stack overflow |YES
|Multiple Fails |Bug found in >1 place in same session |YES
|Complex Root Cause |>3 symptoms from single root cause |YES
|===

**Factors that allow NO FMEA:**

[cols="1,3"]
|===
|Factor |Justification

|Obvious Fix |One-line code change; root cause clear
|Isolated Bug |Doesn't affect other code paths
|Unverified Code |Fixes code not in formal verification scope
|Test Addition |Only adding tests; no code logic change
|Documentation Fix |Corrects docs; no code change
|===

---

== PM Release Decision (Step 5)

After QA approves (and FMEA complete if required), PM makes release decision (1-day SLA):

=== PM Approval Criteria

```
CAPA RELEASE DECISION (Step 5)
═══════════════════════════════════════════════════════════════

CAPA: #NNN - {Description}
PM Decision-Maker: Robert A. James
Date: {Date}
Decision Deadline: {Date + 1 day}

RELEASE CRITERIA
═══════════════════════════════════════════════════════════════

QUALITY GATES
☐ All tests pass (≥99% pass rate)? {GitHub Actions link}
☐ Code coverage maintained (≥85%)? {Coverage report}
☐ Formal proofs updated (100% lemmas)? {Isabelle status}
☐ Zero new security findings? {SonarQube report}
☐ Valgrind clean (no memory errors)? {Valgrind log}

APPROVAL STATUS
☐ QA has approved this CAPA?
☐ FMEA complete (if required)?
☐ No blockers from other CAPAs?
☐ Previous release issues resolved?

RELEASE IMPACT
☐ Fix doesn't cause new issues?
☐ Regression test prevents re-occurrence?
☐ Performance regression acceptable?
☐ Backward compatible (no data loss)?

DECISION
═══════════════════════════════════════════════════════════════

☐ ✅ APPROVED FOR RELEASE

   Version: v2.0.2 (or next patch/minor/major)
   Release Notes: "CAPA #42 - Fixed stack underflow in DROP"
   Action: Merge PR to master, tag release, close issue

   PM Approval: Robert A. James - {Date}

☐ ❌ HOLD - Not ready for release

   Reason: {Specific blocker}
   Blocked by: {CAPA #X or other issue}
   Next Review: {Date}
   Action: Monitor blocker; revisit when resolved

☐ ⏸️  DEFER - Hold for next release

   Reason: {e.g., "Low priority, include in next scheduled release"}
   Next Review: {Date}
   Action: Include in v2.1.0 planning

═══════════════════════════════════════════════════════════════
```

---

== CAPA Closure (Step 6)

### Automatic Closure

When PR is merged to master with comment `Closes #NNN`:

```bash
commit def456
Author: Robert A. James <rajames@example.com>

Merge PR #XXX: CAPA #42 - Fix stack underflow

Closes #42

✅ All quality gates passed
✅ QA approved
✅ PM approved
✅ Released in v2.0.2
```

**Automatic Actions:**
1. GitHub auto-closes issue #42
2. git tag v2.0.2 created
3. master branch updated
4. Release notes published
5. Audit trail complete (commits + tag)

### Manual Closure (If needed)

If issue doesn't auto-close:
1. Go to GitHub issue #NNN
2. Click "Close issue"
3. Comment: "Closed: Fixed in v2.0.2 released {date}"

---

== Audit Trail & Traceability

Every CAPA creates an immutable record:

[cols="1,2"]
|===
|Artifact |Evidence

|**GitHub Issue** |Problem statement, comments, decisions
|**Git Commits** |Code changes with "CAPA #NNN" reference
|**Git Tag** |vX.Y.Z marks released fix
|**Release Notes** |Human-readable summary of fix
|**Test Code** |Regression test validates fix
|**Isabelle Proofs** |Formal verification (if verified code)
|**PR Comments** |QA/PM approvals and reasoning
|===

**Example Audit Trail for CAPA #42:**

```
Issue: #42 "Stack underflow in DROP word"
├─ Reporter: {user}
├─ Severity: CRITICAL
├─ Description: DROP on empty stack causes segfault
│
Commits:
├─ abc123: "fix: CAPA #42 - Add bounds check in DROP"
│          └─ file: src/stack.c, lines 285-290
│          └─ test: tests/test_capa_42.c added
│
QA Validation:
├─ Date: 2025-10-30
├─ Validator: Robert A. James
├─ Status: APPROVED
├─ Regression test: ✓ Passes
├─ Coverage: ✓ 87% (maintained)
│
FMEA Decision:
├─ Risk level: MEDIUM (isolated bug, no systemic risk)
├─ FMEA required: NO (brief assessment sufficient)
├─ Assessment: Single-function fix, obvious root cause
│
PM Approval:
├─ Date: 2025-10-30
├─ Approver: Robert A. James
├─ Status: APPROVED FOR RELEASE
├─ Target version: v2.0.2
│
Release:
├─ Merged: 2025-10-30
├─ Tag: v2.0.2
├─ Release notes: "Fixed stack underflow in DROP word"
├─ Issue closed: Automatic (Closes #42)
│
Status: CLOSED / RELEASED
└─ Users can upgrade to v2.0.2 to get fix
```

---

== Common CAPA Scenarios

=== Scenario 1: Simple Logic Bug

**CAPA:** "DROP fails on empty stack"
- Root cause: Missing bounds check
- Fix: Add if (stack_ptr < 1) check
- FMEA: No (obvious fix, isolated)
- Timeline: 1 day

=== Scenario 2: Memory Leak

**CAPA:** "Block storage leaks memory"
- Root cause: Buffer not freed after use
- Fix: Add free() call in cleanup
- FMEA: Optional (investigate if other leaks exist)
- Timeline: 2 days

=== Scenario 3: Verified Code Bug

**CAPA:** "Arithmetic lemma unsound"
- Root cause: Proof has gap (sorry/admit used)
- Fix: Complete Isabelle proof
- FMEA: YES (affects formal verification)
- Timeline: 3-5 days

---

== Compliance References

This CAPA process aligns with:

- **ISO 9001:2015** § 8.5.2 (Control of production and service provision)
- **ISO/IEC 12207:2017** § 6.3 (Problem resolution)
- **21 CFR Part 11** (Electronic records traceability)
- **IEC 62304:2015** § 7.5 (Problem resolution)

---

== Change History

[cols="1,2,3"]
|===
|Version |Date |Changes

|1.0.0 |2025-10-30 |Initial CAPA process with QA validation checklist, FMEA decision gate, PM approval (1-day SLA), and audit trail requirements
|===

---

**Next:** Chapter 4 - FMEA_PROCESS.adoc (Formal failure analysis for HIGH RISK CAPAs)

**Related:**
- Chapter 2 - ECO_PROCESS.adoc - Compare with preventive ECO changes
- Chapter 4 - FMEA_PROCESS.adoc - Formal risk analysis (if REQUIRED)
- QUALITY_POLICY.adoc - Quality objectives maintenance
- TEST_STRATEGY.adoc - Regression testing requirements

---

**Maintained by:** Robert A. James (QA/PM)
**Last Updated:** October 30, 2025
**Status:** ACTIVE - Ready for immediate use in incident response

== Approvals & Signature

[cols="2,3,2,2", options="header"]
|===
| Role | Name | Date | Signature
| Product Manager | Robert A. James | ________ | ________________
| QA Lead | [Name or N/A] | ________ | ________________
| Governance | [Name or N/A] | ________ | ________________
|===

**Status:** [SIGNATURE REQUIRED]
**Instructions:** Enter today's date and your esignature in the "Signature" column.
Format: `/s/ Robert A. James` or your handwritten signature if printed.

