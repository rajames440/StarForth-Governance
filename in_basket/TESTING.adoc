== StarForth Test Suite
:toc: left
:toc-title: Contents
:toclevels: 3
xref:../README.adoc[â† Back to Documentation Index]



The *StarForth* virtual machine includes a comprehensive, built-in
testing framework designed to validate the behavior of standard Forth
words across normal, edge, and error conditions. This ensures strict
Forth-79/83 compliance and provides a robust platform for extensibility
and validation.

'''''

=== âœ… Features

* Modular test suite organized by word group
* Covers stack manipulation, arithmetic, logical, I/O, memory, and
return stack operations
* Differentiates between *normal*, *edge*, and *error* test cases
* Supports skipped/unimplemented test markers
* Preserves and restores VM state between tests
* *Automatic dictionary cleanup* - removes test-created words after each
suite
* *Zero dictionary pollution* - each test suite starts with clean
dictionary state
* Detailed logging with result categories: PASS, FAIL, SKIP, ERROR

'''''

=== ğŸ¤– Test Case Structure

Each test suite (`+WordTestSuite+`) contains:

* A *Forth word name* (e.g.Â `+DUP+`, `+++`, `+EMIT+`)
* An array of *test cases* (`+TestCase[]+`):
** `+name+`: A short test name
** `+input+`: A Forth string to evaluate
** `+expected+`: A human-readable description of expected behavior
** `+test_type+`: One of `+TEST_NORMAL+`, `+TEST_EDGE_CASE+`, or
`+TEST_ERROR_CASE+`
** `+should_error+`: Whether the VM is expected to throw an error
** `+implemented+`: Flag to skip tests if not implemented

'''''

=== âš™ï¸ Running the Test Suite

Build the project first:

[source,bash]
----
make clean && make
----

Then run the REPL binary with embedded tests:

[source,bash]
----
./build/starforth --run-tests
----

_(Requires a command-line flag to be implemented if not already
present)_

Or invoke `+run_all_tests(&global_vm);+` from `+main()+` for automated
testing.

'''''

=== ğŸ¤· Sample Test Output

....
[INFO] Starting comprehensive FORTH-79 test suite...
[INFO] ==============================================

Testing word: DUP
------------------------
  [PASS] DUP.basic
  [PASS] DUP.zero
  [FAIL] DUP.max_int
  [SKIP] DUP.not_implemented_case
  [ERROR] DUP.empty_stack
  DUP: 2 passed, 1 failed, 1 skipped, 1 error

...

FINAL TEST SUMMARY:
  Total tests: 91
  Passed: 87
  Failed: 2
  Skipped: 1
  Errors: 1
[ERROR] 3 tests FAILED or had ERRORS!
....

'''''

=== ğŸ›ï¸ Categories

==== Stack Manipulation

* `+DUP+`, `+DROP+`, `+SWAP+`, `+OVER+`, `+ROT+`

==== Arithmetic

* `+++`, `+-+`, `+*+`, `+/+`, `+MOD+`

==== Logical / Comparison

* `+=+`, `+<+`

==== I/O

* `+EMIT+`, `+CR+`

==== Memory

* `+!+` (store), `+@+` (fetch)

==== Return Stack

* `+>R+`, `+R>+`, `+R@+`

'''''

=== âš–ï¸ Adding Tests

[arabic]
. Locate the correct `+WordTestSuite+` in `+src/test/test.c+`
. Append a new `+TestCase+` entry with:

[source,c]
----
{"test_name", "forth string", "expectation", TEST_TYPE, should_error, 1},
----

[arabic, start=3]
. Add additional suites if needed:

[source,c]
----
{ "NEWWORD", { {"case1", "input", "desc", TEST_NORMAL, 0, 1}, ... }, N },
----

[arabic, start=4]
. Rebuild and re-run the suite.

'''''

=== ğŸ›¡ï¸ Assertion Helpers

* `+assert_stack_depth(vm, expected_depth)+`
* `+assert_stack_top(vm, expected_value)+`
* `+assert_vm_error(vm, should_have_error)+`

These can be expanded into deeper validation logic in future iterations.

'''''

=== ğŸ§¹ Dictionary Cleanup System

*NEW in 2025*: StarForth now features automatic dictionary cleanup to
prevent test pollution!

==== How It Works

Each test suite automatically:

[arabic]
. *Saves* dictionary state before running (captures `+vm->latest+` and
`+vm->here+`)
. *Executes* all test cases (which may create temporary words)
. *Restores* dictionary state after completion (removes all test-created
words)

==== Benefits

âœ… *Test Isolation* - Each suite starts with a clean dictionary âœ… *No
Pollution* - Test words donâ€™t leak into subsequent tests âœ… *Memory
Safety* - Unreachable memory is reclaimed at VM termination âœ…
*Reliability* - Tests canâ€™t interfere with each other

==== Implementation Details

[source,c]
----
// In run_test_suite():
DictEntry *saved_latest;
size_t saved_here;
save_dict_state(vm, &saved_latest, &saved_here);

// ... run tests ...

restore_dict_state(vm, saved_latest, saved_here);
----

This ensures that words like `+TESTWORD+`, `+MYVOC+`, `+ISOWORD+`
created during testing are automatically cleaned up and wonâ€™t pollute
the global dictionary.

==== State Management Functions

* `+save_vm_state()+` - Saves stack pointers, error state, mode
* `+restore_vm_state()+` - Restores VM state and clears control flags
* `+save_dict_state()+` - Saves dictionary pointers (NEW)
* `+restore_dict_state()+` - Restores dictionary pointers (NEW)

'''''

=== ğŸ”’ Future Enhancements

* CLI flag support for filtering test runs
* Colored terminal output for quick visual pass/fail review
* Output to JUnit XML or Markdown for CI integration
* Regression mode to re-run only failing tests

'''''

=== ğŸš€ Why It Matters

This framework ensures *StarForth* remains deterministic, robust, and
secure across future modifications and extensions. It serves as the
compliance layer for system-critical builds and embedded deployments.

Every word tested, every word trusted.

'''''

*Made with love and a strong stack discipline by R. A. James* â€” and
sniff-verified by *Santino* ğŸ¾
