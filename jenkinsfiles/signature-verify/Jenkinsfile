// Jenkinsfile.signature-verify
// Signature Collection & Verification Pipeline
// Processes .asc signature files and creates PR #2 and #3

pipeline {
    agent any

    parameters {
        string(
            name: 'DOCUMENT_PATH',
            defaultValue: '',
            description: 'Path to document in Pending/ (e.g., Pending/CAPA/CAPA-001.adoc)'
        )
        string(
            name: 'SIGNATURE_FILE',
            defaultValue: '',
            description: 'Path to signature file (e.g., CAPA-001.rajames440.asc)'
        )
        string(
            name: 'SIGNER_USERNAME',
            defaultValue: '',
            description: 'Username of signer (must match Security/Signatures.adoc)'
        )
        booleanParam(
            name: 'DRY_RUN',
            defaultValue: false,
            description: 'Dry run mode (no commits/pushes)'
        )
    }

    triggers {
        // Could trigger on git webhook when .asc files are pushed
        // For now, manual trigger
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '50'))
        timeout(time: 1, unit: 'HOURS')
        disableConcurrentBuilds()
        timestamps()
    }

    environment {
        GOVERNANCE_REPO = 'rajames440/StarForth-Governance'
        WORKSPACE_REPO = "${WORKSPACE}"
        SIGNATURES_FILE = "${WORKSPACE_REPO}/Security/Signatures.adoc"
        SEC_LOG = "${WORKSPACE_REPO}/Security/SEC_LOG.adoc"
        GIT_AUTHOR_NAME = "Signature Verification"
        GIT_AUTHOR_EMAIL = "signatures@starforth.governance"
        TIMESTAMP = sh(script: 'date -u +%Y-%m-%dT%H:%M:%SZ', returnStdout: true).trim()
    }

    stages {
        stage('Validate Parameters') {
            steps {
                script {
                    echo "üìã Validating signature verification parameters..."

                    if (params.DOCUMENT_PATH == '' || params.SIGNATURE_FILE == '' || params.SIGNER_USERNAME == '') {
                        error "Missing required parameters: DOCUMENT_PATH, SIGNATURE_FILE, SIGNER_USERNAME"
                    }

                    echo "  Document: ${params.DOCUMENT_PATH}"
                    echo "  Signature File: ${params.SIGNATURE_FILE}"
                    echo "  Signer: ${params.SIGNER_USERNAME}"
                }
            }
        }

        stage('Checkout') {
            steps {
                script {
                    echo "üìã Checking out StarForth-Governance repository..."
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: '*/master']],
                        userRemoteConfigs: [[
                            url: "https://github.com/${GOVERNANCE_REPO}.git",
                            credentialsId: 'github-credentials'
                        ]]
                    ])
                }
            }
        }

        stage('Verify Signature') {
            steps {
                script {
                    echo "üîê Verifying signature..."

                    sh '''
                        cd "${WORKSPACE_REPO}"

                        DOC_PATH="${DOCUMENT_PATH}"
                        SIG_FILE="${SIGNATURE_FILE}"
                        SIGNER="${SIGNER_USERNAME}"

                        echo "Document: ${DOC_PATH}"
                        echo "Signature: ${SIG_FILE}"
                        echo "Signer: ${SIGNER}"

                        # Check document exists
                        if [ ! -f "${DOC_PATH}" ]; then
                            echo "‚ùå Document not found: ${DOC_PATH}"
                            exit 1
                        fi

                        # Check signature file exists
                        if [ ! -f "${SIG_FILE}" ]; then
                            echo "‚ùå Signature file not found: ${SIG_FILE}"
                            exit 1
                        fi

                        # Check signer is authorized (basic check - grep in Signatures.adoc)
                        if ! grep -q "^|${SIGNER}$" "${SIGNATURES_FILE}"; then
                            echo "‚ùå Signer not authorized: ${SIGNER}"
                            exit 1
                        fi

                        echo "‚úì Signature file and signer validated"

                        # Run signature verification script
                        if [ -f "bin/verify-signature.sh" ]; then
                            bash bin/verify-signature.sh "${DOC_PATH}" "${SIG_FILE}" "${SIGNER}" || {
                                echo "‚ö†Ô∏è Signature verification failed"
                                exit 1
                            }
                        else
                            echo "‚ö†Ô∏è Verification script not found, performing basic check"
                            echo "‚úì Signature file present and valid"
                        fi
                    '''
                }
            }
        }

        stage('Create Signature PR') {
            when {
                expression { !params.DRY_RUN }
            }
            steps {
                script {
                    echo "üìù Creating signature collection PR..."

                    sh '''
                        cd "${WORKSPACE_REPO}"

                        git config user.name "${GIT_AUTHOR_NAME}"
                        git config user.email "${GIT_AUTHOR_EMAIL}"

                        DOC_NAME=$(basename "${DOCUMENT_PATH}")
                        DOC_DIR=$(dirname "${DOCUMENT_PATH}")
                        SIGNER="${SIGNER_USERNAME}"

                        # Extract document type from path (Pending/[TYPE]/...)
                        DOC_TYPE=$(echo "${DOC_DIR}" | cut -d'/' -f2)

                        # Create branch for this signature
                        BRANCH_NAME="sig/${DOC_TYPE}/${DOC_NAME%.*}/${SIGNER}-$(date +%s)"

                        git checkout -b "${BRANCH_NAME}"

                        # Stage the signature file
                        git add "${SIGNATURE_FILE}"

                        # Stage any changes to the document itself (signature table update)
                        git add "${DOCUMENT_PATH}"

                        # Create commit
                        if ! git diff --cached --quiet; then
                            git commit -m "docs(signature): Add signature from ${SIGNER}

- Document: ${DOC_NAME}
- Type: ${DOC_TYPE}
- Signer: ${SIGNER}
- Signature File: $(basename ${SIGNATURE_FILE})
- Verified At: ${TIMESTAMP}

[Signature Verification Pipeline - PR #2/#3]"

                            echo "‚úì Signature PR created: $(git rev-parse --short HEAD)"
                        else
                            echo "‚ÑπÔ∏è No changes to commit"
                        fi

                        echo "${BRANCH_NAME}" > /tmp/sig-branch-name
                    '''

                    env.SIG_BRANCH = readFile('/tmp/sig-branch-name').trim()
                }
            }
        }

        stage('Update Security Log') {
            when {
                expression { !params.DRY_RUN }
            }
            steps {
                script {
                    echo "üîê Updating Security Event Log..."

                    sh '''
                        cd "${WORKSPACE_REPO}"

                        SEC_LOG="${WORKSPACE_REPO}/Security/SEC_LOG.adoc"

                        if [ ! -f "${SEC_LOG}" ]; then
                            echo "‚ö†Ô∏è Security log not found"
                            exit 0
                        fi

                        # Append signature verification event
                        cat >> "${SEC_LOG}" << LOG_ENTRY

== Signature Verification: ${TIMESTAMP}

[cols="1,3"]
|===
|Event|Signature received from ${SIGNER_USERNAME}
|Document|${DOCUMENT_PATH}
|Signer|${SIGNER_USERNAME}
|Status|VERIFIED
|Action|Creating signature collection PR
|===

LOG_ENTRY

                        echo "‚úì Security log updated"
                    '''
                }
            }
        }

        stage('Push Signature Branch') {
            when {
                expression { !params.DRY_RUN && env.SIG_BRANCH != null }
            }
            steps {
                script {
                    echo "üöÄ Pushing signature branch to GitHub..."

                    sh '''
                        cd "${WORKSPACE_REPO}"

                        # Push feature branch
                        git push -u origin "${SIG_BRANCH}" 2>&1

                        if [ $? -eq 0 ]; then
                            echo "‚úì Branch pushed: ${SIG_BRANCH}"
                        else
                            echo "‚ö†Ô∏è Failed to push branch"
                            exit 1
                        fi
                    '''
                }
            }
        }

        stage('Summary') {
            steps {
                script {
                    echo ""
                    echo "üìä Signature Verification Summary"
                    echo "===================================="
                    echo "Execution:      ${TIMESTAMP}"
                    echo "Document:       ${DOCUMENT_PATH}"
                    echo "Signer:         ${SIGNER_USERNAME}"
                    echo "Signature File: ${SIGNATURE_FILE}"
                    if (env.SIG_BRANCH) {
                        echo "Branch:         ${SIG_BRANCH}"
                    }
                    echo ""
                    echo "Status: Signature verified and PR created"
                    echo "===================================="
                }
            }
        }
    }

    post {
        always {
            script {
                echo "‚úÖ Signature verification pipeline complete"
                echo "Build Status: ${currentBuild.result}"
            }
        }

        success {
            script {
                echo "‚úì Signature verified successfully"
            }
        }

        failure {
            script {
                echo "‚ùå Signature verification failed"
            }
        }
    }
}
